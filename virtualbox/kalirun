#!/bin/sh

VMDIR="/Users/Shared/kali"

if [ $(id -u) = 0 ]; then
    KALIRUNNING=$(sudo -u $SUDO_USER vboxmanage list runningvms)
    echo $KALIRUNNING | grep -q "kali"
    if [ "$?" = 0 ]; then
        printf "%s\n" "[!] VM is already running. Rerun this script as Non-Root User."
        exit 1
    fi
else
    KALIRUNNING=$(vboxmanage list runningvms)
fi

echo $KALIRUNNING | grep -q "kali"
if [ ! "$?" = 0 ]; then
    vboxmanage startvm --type headless kali >/dev/null 2<&1
    if [ ! "$?" = 0 ]; then
        if [ ! "$(id -u)" = 0 ]; then
            printf "%s\n" "[*] .vbox File has wrong Permissions.."
            printf "%s\n" "[!] Please run this script as root"
            exit 1
        fi
        printf "%s\n" "[*] Changing permissions!"
        chown -R $SUDO_USER:wheel $VMDIR
        printf "%s\n" "[*] Permissions changed.. Please rerun this script as non-root User.."
        exit 0 
    fi
    
    printf "%s\n" "[*] Starting OS."

    printf "%s" "[*] Connecting.."
    STARTED=1
    while [ ! "$STARTED" = 0 ]; do
        sleep 1
        printf '.'
        nc -z -G 1 kali 22 >/dev/null 2<&1
        if [ "$?" = 0 ]; then
            STARTED=0
            printf "%s\n"
            ssh -q -o h3105@kali
        fi
    done
else
    if [ "$(id -u)" = 0 ]; then
        sudo -u $SUDO_USER ssh h3105@kali
    else
        ssh h3105@kali
    fi
fi
